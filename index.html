<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>APEX | System</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #111111;
            --primary: #00f0ff;
            --primary-glow: #00aaff;
            --text-main: #e0e0e0;
            --text-dim: #666;
            --danger: #ff003c;
            --success: #00ff9d;
            --warning: #ffcc00;
            --border: 1px solid #333;
            
            /* Heatmap Colors - GitHub style */
            --heat-0: #161b22;
            --heat-1: #0e4429;
            --heat-2: #006d32;
            --heat-3: #26a641;
            --heat-4: #39d353;
            
            --font-display: 'Courier New', Courier, monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- INTRO ANIMATION --- */
        #intro-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease-out;
            background: radial-gradient(circle at center, #050505 0%, #000 100%);
        }
        .logo-anim { 
            font-family: var(--font-display); 
            font-size: 4.5rem; 
            font-weight: 900; 
            color: var(--primary); 
            letter-spacing: 10px; 
            margin-bottom: 2rem;
            text-shadow: 0 0 30px var(--primary), 0 0 60px var(--primary);
            animation: glitch 2s infinite;
        }
        .slogan-anim { 
            font-family: var(--font-display); 
            font-size: 1.2rem; 
            color: var(--text-dim); 
            opacity: 0; 
            transform: translateY(20px); 
            animation: fadeUp 1.5s forwards 0.5s; 
            letter-spacing: 3px; 
        }

        @keyframes glitch {
            0% { transform: translate(0); text-shadow: 0 0 20px var(--primary); }
            20% { transform: translate(-2px, 2px); text-shadow: -2px 0 var(--danger); }
            40% { transform: translate(2px, -2px); text-shadow: 2px 0 var(--primary); }
            60% { transform: translate(0); }
            100% { transform: translate(0); }
        }
        @keyframes fadeUp { 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- LAYOUT --- */
        #app-container { display: flex; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s; }
        #app-container.visible { opacity: 1; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; 
            background: var(--panel-bg); 
            border-right: var(--border);
            display: flex; flex-direction: column; padding: 1.5rem; z-index: 10; flex-shrink: 0;
            overflow-y: auto;
        }
        .sidebar-brand { 
            font-family: var(--font-display); 
            font-weight: bold; 
            color: var(--primary); 
            font-size: 1.5rem; 
            margin-bottom: 2rem; 
            letter-spacing: -1px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .sidebar-date {
            font-size: 0.85rem; 
            color: var(--text-dim); 
            font-family: var(--font-display);
            background: #000; 
            padding: 4px 8px; 
            border-radius: 4px; 
            border: var(--border);
        }

        .nav-btn {
            background: none; 
            border: none; 
            color: var(--text-dim); 
            padding: 0.8rem;
            text-align: left; 
            cursor: pointer; 
            font-family: var(--font-display);
            font-size: 0.9rem; 
            transition: 0.2s; 
            border-radius: 4px; 
            margin-bottom: 0.2rem;
        }
        .nav-btn:hover { 
            background: #1a1a1a; 
            color: var(--text-main); 
        }
        .nav-btn.active { 
            background: rgba(0, 240, 255, 0.1); 
            color: var(--primary); 
            border-left: 3px solid var(--primary);
        }

        /* Sidebar Habit List */
        .sidebar-section-title { 
            font-size: 0.7rem; 
            color: #444; 
            margin: 1.5rem 0 0.5rem; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }
        .sidebar-habit-item {
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 8px; 
            font-size: 0.85rem; 
            color: #ccc; 
            background: #161616;
            margin-bottom: 4px; 
            border-radius: 4px; 
            transition: 0.2s;
        }
        .sidebar-habit-item:hover { 
            background: #222; 
        }
        .sb-del { 
            color: #444; 
            cursor: pointer; 
            font-size: 1.1rem; 
        }
        .sb-del:hover { 
            color: var(--danger); 
        }

        /* Player Stats in Sidebar */
        .player-stats {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(0, 240, 255, 0.2);
        }
        .stat-bar {
            margin-bottom: 1rem;
        }
        .stat-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 5px;
        }
        .stat-fill {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .stat-fill-inner {
            height: 100%;
            transition: width 0.5s ease;
        }
        .stamina-fill { background: linear-gradient(90deg, #00ff9d, #00cc7a); }
        .strength-fill { background: linear-gradient(90deg, #ffcc00, #ff9900); }

        /* Stats Info Tooltip */
        .stat-info {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-recovery {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .recovery-icon {
            color: var(--success);
            font-size: 0.8rem;
        }

        /* Recruits Section */
        .recruits-section {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(0, 240, 255, 0.2);
        }
        .recruits-count {
            text-align: center;
            font-family: var(--font-display);
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .recruit-btn { 
            background: linear-gradient(90deg, var(--primary), var(--primary-glow));
            color: #000; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-family: var(--font-display);
            font-size: 0.8rem;
            transition: all 0.3s;
            width: 100%;
            margin-top: 0.5rem;
        }
        .recruit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.5);
        }
        .recruit-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        .recruit-btn:disabled:hover {
            background: #666;
            transform: none !important;
            box-shadow: none !important;
        }

        /* --- MAIN CONTENT --- */
        .main-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; 
        }
        .scroll-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 2rem; 
            max-width: 1000px; 
            margin: 0 auto; 
            width: 100%; 
        }

        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- DASHBOARD COMPONENTS --- */
        .xp-section { 
            margin-bottom: 2rem; 
            text-align: center; 
        }
        .level-badge { 
            font-family: var(--font-display); 
            color: var(--primary); 
            font-size: 0.9rem; 
            margin-bottom: 0.5rem; 
            display: block; 
        }
        .xp-track { 
            width: 100%; 
            height: 12px; 
            background: #222; 
            border-radius: 6px; 
            overflow: hidden; 
            border: var(--border); 
        }
        .xp-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--panel-bg), var(--primary));
            width: 0%; 
            transition: width 0.5s ease; 
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
        }
        .xp-text { 
            font-family: var(--font-display); 
            font-size: 0.8rem; 
            color: var(--text-dim); 
            margin-top: 5px; 
            display: block; 
        }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 1rem; 
            margin-bottom: 2rem; 
            background: var(--panel-bg); 
            padding: 1.5rem; 
            border-radius: 8px; 
            border: var(--border);
        }
        .stat-box { 
            text-align: center; 
        }
        .stat-val { 
            display: block; 
            font-family: var(--font-display); 
            font-size: 1.8rem; 
            color: var(--text-main); 
            font-weight: bold; 
        }
        .stat-lbl { 
            font-size: 0.75rem; 
            color: var(--text-dim); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }
        .stat-val.highlight { 
            color: var(--primary); 
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.3); 
        }

        /* Habit Cards */
        .habit-list { 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
        }
        .habit-card { 
            background: var(--panel-bg); 
            border: var(--border); 
            padding: 1.2rem; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            transition: 0.2s; 
        }
        .habit-card:hover { 
            transform: translateX(5px); 
            border-color: #444; 
        }
        .habit-card.completed { 
            border-left: 4px solid var(--success); 
            background: rgba(0, 255, 157, 0.03); 
        }
        .habit-left { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            flex: 1; 
        }
        .check-btn { 
            width: 24px; 
            height: 24px; 
            border: 2px solid #555; 
            border-radius: 50%; 
            background: transparent; 
            cursor: pointer; 
            display: grid; 
            place-items: center; 
        }
        .habit-card.completed .check-btn { 
            border-color: var(--success); 
            background: rgba(0, 255, 157, 0.2); 
        }
        .habit-card.completed .check-btn::after { 
            content: '‚úì'; 
            color: var(--success); 
            font-size: 0.8rem; 
        }
        .habit-title { 
            font-weight: 600; 
            font-size: 1.1rem; 
        }
        .habit-meta { 
            font-size: 0.8rem; 
            color: var(--text-dim); 
            display: flex; 
            gap: 10px; 
            margin-top: 4px; 
        }
        .delete-btn { 
            background: none; 
            border: none; 
            color: #333; 
            cursor: pointer; 
            font-size: 1.2rem; 
            padding: 0.5rem; 
            transition: 0.2s; 
        }
        .delete-btn:hover { 
            color: var(--danger); 
        }

        .difficulty-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
        }
        .difficulty-easy { background: rgba(0, 255, 157, 0.2); color: var(--success); }
        .difficulty-medium { background: rgba(255, 204, 0, 0.2); color: var(--warning); }
        .difficulty-hard { background: rgba(255, 0, 60, 0.2); color: var(--danger); }

        /* Stamina Info Panel */
        .stamina-info {
            background: var(--panel-bg);
            border: var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stamina-details {
            flex: 1;
        }
        .stamina-title {
            font-family: var(--font-display);
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .stamina-benefits {
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        .stamina-benefits li {
            margin-bottom: 3px;
        }
        .recovery-actions {
            display: flex;
            gap: 0.5rem;
        }
        .recovery-btn {
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid rgba(0, 255, 157, 0.3);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .recovery-btn:hover {
            background: rgba(0, 255, 157, 0.2);
            transform: translateY(-2px);
        }
        .recovery-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .recovery-btn:disabled:hover {
            background: rgba(0, 255, 157, 0.1);
            transform: none;
        }

        /* Floating Action Button */
        #fab { 
            position: fixed; 
            bottom: 2rem; 
            right: 2rem; 
            width: 60px; 
            height: 60px; 
            background: var(--primary); 
            color: #000; 
            border-radius: 50%; 
            border: none; 
            font-size: 2rem; 
            cursor: pointer; 
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.4); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.3s; 
            z-index: 100; 
        }
        #fab:hover { 
            transform: scale(1.1) rotate(90deg); 
            background: #fff; 
        }

        /* --- MODAL --- */
        .modal-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(5px); 
            z-index: 200; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        .modal-overlay.open { 
            display: flex; 
            opacity: 1; 
        }
        .modal-box { 
            background: var(--panel-bg); 
            width: 90%; 
            max-width: 400px; 
            padding: 2rem; 
            border: 1px solid #333; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            transform: scale(0.9); 
            transition: transform 0.3s; 
        }
        .modal-overlay.open .modal-box { 
            transform: scale(1); 
        }
        .input-field { 
            width: 100%; 
            padding: 0.8rem; 
            background: #000; 
            border: 1px solid #333; 
            color: #fff; 
            margin-bottom: 1rem; 
            border-radius: 4px; 
        }
        .day-selector { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 1rem; 
        }
        .day-btn { 
            width: 32px; 
            height: 32px; 
            border: 1px solid #333; 
            background: #000; 
            color: #666; 
            border-radius: 4px; 
            cursor: pointer; 
            display: grid; 
            place-items: center; 
            font-size: 0.8rem; 
        }
        .day-btn.selected { 
            background: var(--primary); 
            color: #000; 
            font-weight: bold; 
        }
        .btn-primary { 
            width: 100%; 
            background: var(--primary); 
            color: #000; 
            border: none; 
            padding: 1rem; 
            font-weight: bold; 
            border-radius: 4px; 
            cursor: pointer; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }

        /* --- TIMER --- */
        .timer-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            background: var(--panel-bg);
            border-radius: 15px;
            border: var(--border);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 600px;
        }

        .timer-modes {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: #000;
            padding: 0.5rem;
            border-radius: 20px;
            border: var(--border);
        }

        .mode-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 15px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 0.9rem;
            transition: all 0.3s;
            min-width: 120px;
        }

        .mode-btn:hover {
            background: rgba(0, 240, 255, 0.1);
            color: var(--text-main);
        }

        .mode-btn.active {
            background: var(--primary);
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
        }

        .timer-display {
            font-family: var(--font-display);
            font-size: 4.5rem;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            color: var(--text-main);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
        }

        .timer-status {
            font-family: var(--font-display);
            color: var(--primary);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .timer-cycle {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .timer-btn {
            padding: 1rem 2rem;
            background: #000;
            border: 2px solid #333;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-display);
            transition: all 0.3s;
            min-width: 120px;
            font-size: 1rem;
        }

        .timer-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .timer-btn.active {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
            font-weight: bold;
        }

        .timer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .timer-btn:disabled:hover {
            border-color: #333;
            transform: none;
        }

        /* Timer Progress Circle */
        .timer-circle {
            position: relative;
            width: 280px;
            height: 280px;
            margin-bottom: 2rem;
        }

        .timer-ring-svg {
            transform: rotate(-90deg);
            width: 280px;
            height: 280px;
        }

        .timer-ring-bg {
            fill: none;
            stroke: #222;
            stroke-width: 8;
        }

        .timer-ring-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
            filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.3));
        }

        /* Laps Container (Stopwatch) */
        .laps-container {
            width: 100%;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            background: #000;
            border: var(--border);
            border-radius: 8px;
            margin-bottom: 1rem;
            padding: 15px;
            display: none;
        }

        .laps-container.active {
            display: block;
        }

        .laps-header {
            font-family: var(--font-display);
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .lap-item {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-display);
            font-size: 0.9rem;
            border-bottom: 1px solid #222;
            padding: 8px 0;
            color: #888;
        }

        .lap-item:last-child {
            border-bottom: none;
        }

        .lap-num {
            color: var(--primary);
            font-weight: bold;
        }

        .lap-time {
            color: var(--text-main);
        }

        .lap-diff {
            color: var(--danger);
            font-size: 0.8rem;
        }

        /* --- HISTORY VIEW (from index.html) --- */
        .history-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 2rem; 
            margin-bottom: 2rem; 
            min-height: 300px; /* Ensure minimum height */
        }
        .chart-container { 
            height: 250px; 
            position: relative; 
            width: 100%; 
            min-height: 250px; /* Ensure chart has minimum height */
        }
        .ring-container-large { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 250px; 
            position: relative; 
            min-height: 250px; /* Ensure ring has minimum height */
        }
        .ring-large-svg { width: 200px; height: 200px; transform: rotate(-90deg); }
        .ring-large-bg { stroke: var(--panel-bg); }
        .ring-large-fill { stroke: var(--primary); stroke-linecap: round; transition: stroke-dashoffset 1s ease; }
        .ring-text-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .ring-percent { font-size: 2.5rem; font-weight: 700; color: var(--text-main); }
        .ring-label { color: var(--text-dim); font-size: 0.9rem; }

        .calendar-container { 
            background: var(--panel-bg); 
            padding: 1.5rem; 
            border-radius: 16px; 
            border: var(--border); 
            min-height: 300px; /* Ensure calendar has minimum height */
            margin-bottom: 2rem;
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); 
            gap: 6px; 
            margin-top: 1rem; 
            min-height: 200px; /* Ensure calendar grid has minimum height */
        }
        .cal-day { aspect-ratio: 1; border-radius: 4px; background: var(--bg-color); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--text-dim); position: relative; }
        .cal-day.today { border: 1px solid var(--primary); color: var(--primary); }
        .cal-day.completed { background-color: var(--primary); color: #000; }

        /* Activity Map Container for better scrolling */
        .activity-map-container {
            min-height: 400px; /* Ensure enough height for scrolling */
        }

        /* --- ARMY VIEW --- */
        .army-stats {
            background: var(--panel-bg);
            border: var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .soldier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .soldier-card {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s;
        }

        .soldier-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .soldier-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .soldier-name {
            font-family: var(--font-display);
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .soldier-level {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        /* --- RESPONSIVE --- */
        @media(max-width: 768px) {
            .history-grid { 
                grid-template-columns: 1fr; 
            }
            .sidebar { 
                position: fixed; 
                left: -100%; 
                height: 100%; 
                transition: 0.3s; 
                width: 80%; 
            }
            .sidebar.open { 
                left: 0; 
                box-shadow: 5px 0 20px rgba(0,0,0,0.5); 
            }
            .mobile-menu-btn { 
                display: block; 
                position: absolute; 
                top: 1.5rem; 
                left: 1.5rem; 
                background: none; 
                border: none; 
                color: #fff; 
                font-size: 1.5rem; 
                z-index: 5; 
            }
            .scroll-area { 
                padding: 4rem 1rem 2rem 1rem; 
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .timer-display {
                font-size: 3.5rem;
            }
            
            .timer-circle {
                width: 220px;
                height: 220px;
            }
            
            .timer-ring-svg {
                width: 220px;
                height: 220px;
            }
            
            .mode-btn {
                padding: 0.6rem 1rem;
                min-width: 100px;
                font-size: 0.8rem;
            }
            
            .timer-btn {
                padding: 0.8rem 1.5rem;
                min-width: 100px;
                font-size: 0.9rem;
            }
            
            .stamina-info {
                flex-direction: column;
                gap: 1rem;
            }
            
            .recovery-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        @media(min-width: 769px) { 
            .mobile-menu-btn { 
                display: none; 
            } 
        }
    </style>
</head>
<body>
    <!-- Intro Animation -->
    <div id="intro-overlay">
        <div class="logo-anim">APEX</div>
        <div class="slogan-anim">Consistency Compounds</div>
    </div>
    
    <!-- Add Habit Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal-box">
            <h3 style="font-family: var(--font-display); margin-bottom: 1rem; color: var(--primary);">NEW QUEST</h3>
            <input type="text" id="habit-name" class="input-field" placeholder="Quest Name..." autocomplete="off">
            
            <label style="font-size: 0.8rem; color: #666; margin-bottom: 5px; display: block;">Difficulty (XP)</label>
            <select id="habit-diff" class="input-field">
                <option value="easy">Easy (+10 XP)</option>
                <option value="medium" selected>Medium (+25 XP)</option>
                <option value="hard">Hard (+50 XP)</option>
            </select>
            
            <label style="font-size: 0.8rem; color: #666; margin-bottom: 10px; display: block;">Repeat On:</label>
            <div class="day-selector" id="day-selector">
                <button class="day-btn" data-day="0">S</button>
                <button class="day-btn" data-day="1">M</button>
                <button class="day-btn" data-day="2">T</button>
                <button class="day-btn" data-day="3">W</button>
                <button class="day-btn" data-day="4">T</button>
                <button class="day-btn" data-day="5">F</button>
                <button class="day-btn" data-day="6">S</button>
            </div>
            
            <button style="font-size: 0.8rem; color: var(--primary); background: none; border: none; cursor: pointer; text-decoration: underline; margin-bottom: 1rem; display: block;" onclick="App.toggleEveryday()">Select Every Day</button>
            
            <button class="btn-primary" onclick="App.saveHabit()">Initialize Quest</button>
            
            <button style="background: none; border: none; color: #666; width: 100%; margin-top: 1rem; cursor: pointer;" onclick="App.closeModal()">Cancel</button>
        </div>
    </div>
    
    <!-- Level Up Modal -->
    <div class="modal-overlay" id="level-modal">
        <div class="modal-box" style="text-align: center;">
            <h1 style="color: var(--primary); font-family: var(--font-display); font-size: 3rem; margin-bottom: 1rem;">LEVEL UP</h1>
            <p style="margin-bottom: 2rem; color: #fff;" id="level-msg">You have reached Level 2</p>
            <p style="margin-bottom: 2rem; color: var(--primary); font-family: var(--font-display);" id="level-reward">
                +1 Recruit Added to your Army!
            </p>
            <button class="btn-primary" onclick="App.closeModal('level-modal')">ACKNOWLEDGE</button>
        </div>
    </div>
    
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    
    <!-- Main App Container -->
    <div id="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <span>APEX</span>
                <span id="sidebar-date" class="sidebar-date">DATE</span>
            </div>
            
            <button class="nav-btn active" onclick="App.navigate('dashboard')">üè∞ Dashboard</button>
            <button class="nav-btn" onclick="App.navigate('timer')">‚è≥ Time Chamber</button>
            <button class="nav-btn" onclick="App.navigate('history')">üìú Chronicles</button>
            <button class="nav-btn" onclick="App.navigate('army')">üí™ Recruits</button>
            
            <!-- Player Stats -->
            <div class="player-stats">
                <div class="stat-bar">
                    <div class="stat-label">
                        <span>STAMINA</span>
                        <span id="current-stamina">100</span>/<span id="max-stamina">100</span>
                    </div>
                    <div class="stat-fill">
                        <div class="stat-fill-inner stamina-fill" id="stamina-bar" style="width: 100%;"></div>
                    </div>
                    <div class="stat-info">
                        <span>Recovery: <span class="recovery-icon">‚ö°</span> <span id="stamina-recovery">12/hour</span></span>
                        <span id="strength-bonus">-10% cost</span>
                    </div>
                </div>
                
                <div class="stat-bar">
                    <div class="stat-label">
                        <span>STRENGTH</span>
                        <span id="strength-value">10</span>
                    </div>
                    <div class="stat-fill">
                        <div class="stat-fill-inner strength-fill" id="strength-bar" style="width: 100%;"></div>
                    </div>
                    <div class="stat-info">
                        <span>+5% XP | +10 Max Stamina</span>
                        <span id="strength-change">+0 today</span>
                    </div>
                </div>
            </div>
            
            <!-- Recruits Section -->
            <div class="recruits-section">
                <div class="recruits-count">
                    üí™ <span id="recruits-count">0</span> Recruits
                </div>
                <div style="text-align: center;">
                    <button class="recruit-btn" onclick="App.summonRecruit()" id="summon-btn">
                        Train Recruit (100 XP)
                    </button>
                </div>
            </div>
            
            <div class="sidebar-section-title">Active Quests</div>
            <div id="sidebar-habit-list"></div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="scroll-area">
                <!-- DASHBOARD VIEW -->
                <section id="dashboard" class="view-section active">
                    <div class="xp-section">
                        <span class="level-badge" id="header-level">LVL 1</span>
                        <div class="xp-track">
                            <div class="xp-fill" id="xp-bar"></div>
                        </div>
                        <span class="xp-text" id="xp-text">0 / 100 XP</span>
                    </div>
                    
                    <div class="stamina-info">
                        <div class="stamina-details">
                            <div class="stamina-title">STAMINA SYSTEM</div>
                            <div class="stamina-benefits">
                                <div>‚Ä¢ <strong>Passive Recovery:</strong> 12/hour (1 per 5 min)</div>
                                <div>‚Ä¢ <strong>Strength Bonus:</strong> +10 max stamina per strength point</div>
                                <div>‚Ä¢ <strong>Cost Reduction:</strong> -10% stamina cost per strength point</div>
                            </div>
                        </div>
                        <div class="recovery-actions">
                            <button class="recovery-btn" onclick="App.activeRecovery('easy')" id="easy-recovery">
                                Quick Rest (5 Stamina)
                            </button>
                            <button class="recovery-btn" onclick="App.activeRecovery('meditate')" id="meditate-btn">
                                Meditate (20 Stamina)
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <span class="stat-val highlight" id="best-streak">0</span>
                            <span class="stat-lbl">Best Streak</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-val" id="curr-streak">0</span>
                            <span class="stat-lbl">Current Streak</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-val" id="total-quests">0</span>
                            <span class="stat-lbl">Total Quests</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-val" id="total-recruits">0</span>
                            <span class="stat-lbl">Recruits</span>
                        </div>
                    </div>
                    
                    <h3 style="font-family: var(--font-display); color: var(--text-dim); margin-bottom: 1rem; border-bottom: 1px solid #333; padding-bottom: 0.5rem;">
                        Today's Missions
                    </h3>
                    
                    <div class="habit-list" id="habit-list-container"></div>
                    
                    <div style="height: 80px;"></div>
                </section>
                
                <!-- TIMER VIEW -->
                <section id="timer" class="view-section">
                    <div class="timer-wrapper">
                        <h2 style="font-family: var(--font-display); color: var(--primary); margin-bottom: 2rem; text-align: center;">
                            ‚è≥ TIME CHAMBER
                        </h2>
                        
                        <div class="timer-modes">
                            <button class="mode-btn active" onclick="Timer.setMode('pomodoro')">Pomodoro</button>
                            <button class="mode-btn" onclick="Timer.setMode('stopwatch')">Stopwatch</button>
                        </div>
                        
                        <!-- Laps Container (Stopwatch Only) -->
                        <div id="laps-display" class="laps-container">
                            <div class="laps-header">LAP TIMES</div>
                        </div>
                        
                        <div class="timer-circle">
                            <svg class="timer-ring-svg">
                                <circle class="timer-ring-bg" cx="140" cy="140" r="130"></circle>
                                <circle class="timer-ring-progress" id="timer-progress" cx="140" cy="140" r="130" stroke-dasharray="817" stroke-dashoffset="0"></circle>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div class="timer-display" id="timer-text">25:00</div>
                                <div class="timer-status" id="timer-status">FOCUS</div>
                                <div class="timer-cycle" id="timer-cycle">Cycle: 1/4</div>
                            </div>
                        </div>
                        
                        <div class="timer-controls">
                            <button class="timer-btn active" id="btn-start" onclick="Timer.toggle()">Start</button>
                            <button class="timer-btn" id="btn-lap" onclick="Timer.lap()" disabled>Lap</button>
                            <button class="timer-btn" onclick="Timer.reset()">Reset</button>
                        </div>
                        
                        <div class="timer-info" id="timer-desc">
                            <span id="mode-description">25 min focus, 5 min break. Repeat 4 cycles ‚Üí 20 min long break.</span>
                        </div>
                    </div>
                </section>
                
                <!-- HISTORY VIEW (Replaced with index.html features) -->
                <section id="history" class="view-section">
                    <h2 style="font-family: var(--font-display); color: var(--primary); margin-bottom: 1.5rem;">Chronicles</h2>
                    
                    <div class="history-grid"> 
                       <div class="card"> 
                        <div class="stat-label">
                          Activity Trend (30 Days) 
                        </div> 
                        <div class="chart-container"> 
                         <canvas id="historyChart"></canvas> 
                        </div> 
                       </div> 
                       <div class="card"> 
                        <div class="stat-label">
                          Monthly Consistency 
                        </div> 
                        <div class="ring-container-large"> 
                         <svg class="ring-large-svg" viewbox="0 0 200 200"> <circle class="ring-large-bg" cx="100" cy="100" r="80" stroke-width="12" fill="none"></circle> <circle class="ring-large-fill" id="history-ring" cx="100" cy="100" r="80" stroke-width="12" fill="none" stroke-dasharray="502.65" stroke-dashoffset="502.65"></circle> 
                         </svg> 
                         <div class="ring-text-center"> 
                          <div class="ring-percent" id="history-percent">
                            0% 
                          </div> 
                          <div class="ring-label">
                            Completed 
                          </div> 
                         </div> 
                        </div> 
                       </div> 
                      </div> 
                      <div class="activity-map-container"> 
                       <div class="calendar-container"> 
                        <h3>Activity Map</h3> 
                        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">Month to date view.</p> 
                        <div class="calendar-grid" id="calendar-grid"></div> 
                       </div> 
                      </div>
                </section>
                
                <!-- ARMY VIEW -->
                <section id="army" class="view-section">
                    <h2 style="font-family: var(--font-display); color: var(--primary); margin-bottom: 1.5rem;">üí™ RECRUITS</h2>
                    
                    <div class="army-stats">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="color: var(--text-main); font-family: var(--font-display); margin-bottom: 0.5rem;">
                                    Recruit Army
                                </h3>
                                <p style="color: var(--text-dim); font-size: 0.9rem;">
                                    Train recruits to gain XP bonuses
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2rem; color: var(--primary); font-family: var(--font-display);" id="total-recruits-army">
                                    0
                                </div>
                                <div style="color: var(--text-dim); font-size: 0.8rem;">
                                    Active Recruits
                                </div>
                            </div>
                        </div>
                        
                        <div class="soldier-grid" id="recruits-grid">
                            <!-- Recruits will be generated here -->
                        </div>
                        
                        <div style="margin-top: 2rem; text-align: center;">
                            <button class="recruit-btn" onclick="App.summonRecruit()" id="train-recruit-btn">
                                ‚ö° Train Recruit (Cost: 100 XP)
                            </button>
                            <p style="color: var(--text-dim); margin-top: 1rem; font-size: 0.9rem;">
                                Each recruit provides +5% bonus to all XP gained
                            </p>
                        </div>
                    </div>
                    
                    <div class="chart-card" style="margin-top: 2rem;">
                        <h3 style="color: var(--text-main); font-family: var(--font-display); margin-bottom: 1rem;">
                            Recruit Bonuses
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 240, 255, 0.3);">
                                <div style="color: var(--primary); margin-bottom: 0.5rem; font-family: var(--font-display);">
                                    Tier I: Basic Training
                                </div>
                                <div style="color: var(--text-dim); font-size: 0.9rem;">
                                    1-5 Recruits: +5% XP bonus each
                                </div>
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 240, 255, 0.3); opacity: 0.5;">
                                <div style="color: var(--text-dim); margin-bottom: 0.5rem; font-family: var(--font-display);">
                                    Tier II: Advanced Training
                                </div>
                                <div style="color: var(--text-dim); font-size: 0.9rem;">
                                    6-10 Recruits: +10% XP bonus each (Unlocked at Level 5)
                                </div>
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 240, 255, 0.3); opacity: 0.5;">
                                <div style="color: var(--text-dim); margin-bottom: 0.5rem; font-family: var(--font-display);">
                                    Tier III: Elite Forces
                                </div>
                                <div style="color: var(--text-dim); font-size: 0.9rem;">
                                    11+ Recruits: +15% XP bonus each (Unlocked at Level 10)
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Floating Action Button -->
    <button id="fab" onclick="App.openModal()">+</button>
    
    <script>
        // --- AUDIO SYSTEM ---
        const AudioSys = {
            ctx: null,
            init() {
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Audio not supported');
                }
            },
            play(type) {
                if (!this.ctx) return;
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const now = this.ctx.currentTime;
                if (type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                } else if (type === 'levelup') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.linearRampToValueAtTime(800, now + 0.5);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 1.5);
                    osc.start(now); osc.stop(now + 1.5);
                } else if (type === 'complete') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.linearRampToValueAtTime(1200, now + 0.2);
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'recruit') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.exponentialRampToValueAtTime(400, now + 0.8);
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 1);
                    osc.start(now); osc.stop(now + 1);
                } else if (type === 'recover') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(600, now + 0.5);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 1);
                    osc.start(now); osc.stop(now + 1);
                }
            }
        };

        // --- STATE MANAGEMENT ---
        const STORAGE_KEY = 'apex_final_fixed';
        const defaultState = {
            user: { 
                level: 1, 
                xp: 0, 
                xpToNext: 100, 
                totalCompleted: 0,
                totalXp: 0,
                stamina: 100,
                maxStamina: 100,
                strength: 10,
                recruits: 0,
                lastStaminaUpdate: Date.now(),
                lastStrengthCheck: Date.now(),
                dailyCompletions: 0,
                consecutiveInactiveDays: 0,
                sleepBonusAvailable: true
            },
            habits: [],
            activityLog: {},
            recruits: [],
            timerStats: {
                pomodoroCompleted: 0,
                totalFocusTime: 0,
                bestStreak: 0
            }
        };
        
        let State = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState;

        function saveState() { 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(State)); 
            App.render(); 
        }

        // --- UTILITY FUNCTIONS ---
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getYesterdayDateString() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return getLocalDateString(yesterday);
        }

        // --- HISTORY FUNCTIONS (from index.html) ---
        function drawHistoryChart() {
            const canvas = document.getElementById('historyChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;
            if (!parent || parent.offsetWidth === 0) return;
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;

            const dataPoints = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = getLocalDateString(d);
                const dayIdx = d.getDay();
                const scheduled = State.habits.filter(h => h.days.includes(dayIdx)).length;
                if (scheduled === 0) { dataPoints.push(0); continue; }
                let completed = 0;
                State.habits.forEach(h => { if (h.days.includes(dayIdx) && h.completedDates.includes(dateStr)) completed++; });
                dataPoints.push((completed / scheduled) * 100);
            }

            const colorLine = '#00f0ff'; // Fixed color for dark theme
            const colorFill = 'rgba(0, 240, 255, 0.2)';
            const colorGrid = '#333';

            const w = canvas.width;
            const h = canvas.height;
            const padding = 20;

            ctx.clearRect(0,0,w,h);
            ctx.strokeStyle = colorGrid;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, h - padding);
            ctx.lineTo(w - padding, h - padding);
            ctx.stroke();

            if (dataPoints.length > 1) {
                const stepX = (w - 2*padding) / (dataPoints.length - 1);
                ctx.beginPath();
                ctx.moveTo(padding, h - padding);
                dataPoints.forEach((val, i) => {
                    const x = padding + i * stepX;
                    const y = (h - padding) - (val / 100) * (h - 2*padding);
                    ctx.lineTo(x, y);
                });
                ctx.lineTo(padding + (dataPoints.length - 1) * stepX, h - padding);
                ctx.fillStyle = colorFill;
                ctx.fill();

                ctx.beginPath();
                ctx.strokeStyle = colorLine;
                ctx.lineWidth = 2;
                dataPoints.forEach((val, i) => {
                    const x = padding + i * stepX;
                    const y = (h - padding) - (val / 100) * (h - 2*padding);
                    if (i===0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }
        }

        function drawOverallRing() {
            let totalPossible = 0;
            let totalDone = 0;
            for (let i = 0; i < 30; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = getLocalDateString(d);
                const dayIdx = d.getDay();
                const habits = State.habits.filter(h => h.days.includes(dayIdx));
                totalPossible += habits.length;
                habits.forEach(h => { if(h.completedDates.includes(dateStr)) totalDone++; });
            }
            const pct = totalPossible === 0 ? 0 : Math.round((totalDone / totalPossible) * 100);
            const circle = document.getElementById('history-ring');
            if (circle) {
                const circumference = 502.65; 
                const offset = circumference - (pct / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
            const percentEl = document.getElementById('history-percent');
            if (percentEl) percentEl.textContent = `${pct}%`;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayStr = getLocalDateString();

            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(year, month, i);
                const dateStr = getLocalDateString(d); 
                const dayNum = d.getDate();
                const isToday = dateStr === todayStr;
                const dayIdx = d.getDay();

                const scheduledHabits = State.habits.filter(h => h.days.includes(dayIdx));
                let completedCount = 0;
                scheduledHabits.forEach(h => { 
                    if(h.completedDates.includes(dateStr)) completedCount++; 
                });
                
                const hasCompletion = completedCount > 0 && completedCount === scheduledHabits.length;
                const partial = completedCount > 0 && completedCount < scheduledHabits.length;

                const div = document.createElement('div');
                div.className = `cal-day ${isToday ? 'today' : ''}`;
                if (hasCompletion) div.classList.add('completed');
                if (partial) div.style.backgroundColor = 'rgba(0, 240, 255, 0.3)';
                div.textContent = dayNum;
                grid.appendChild(div);
            }
        }

        // --- APP LOGIC ---
        const App = {
            tempDays: [],
            staminaInterval: null,

            init() {
                // Initialize audio system
                AudioSys.init();
                
                // Start intro animation
                setTimeout(() => {
                    const intro = document.getElementById('intro-overlay');
                    if (intro) {
                        intro.style.opacity = '0';
                        setTimeout(() => {
                            intro.style.display = 'none';
                            document.getElementById('app-container').classList.add('visible');
                        }, 800);
                    }
                }, 2500);
                
                this.updateDate();
                setInterval(() => this.updateDate(), 60000);
                
                // Initialize stamina regeneration
                this.initStaminaSystem();
                
                // Initialize strength system
                this.initStrengthSystem();
                
                // Set up day selector
                document.querySelectorAll('.day-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.target.classList.toggle('selected');
                        const day = parseInt(e.target.dataset.day);
                        if(this.tempDays.includes(day)) {
                            this.tempDays = this.tempDays.filter(d => d !== day);
                        } else {
                            this.tempDays.push(day);
                        }
                    });
                });
                
                this.render();
                
                // Initialize Timer
                Timer.init();
                
                // Initialize History components
                this.renderHistory();
            },

            updateDate() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'short', 
                    day: 'numeric'
                });
                const dateEl = document.getElementById('sidebar-date');
                if (dateEl) dateEl.innerText = dateStr;
            },

            initStaminaSystem() {
                // Calculate stamina regeneration since last update
                const now = Date.now();
                const lastUpdate = State.user.lastStaminaUpdate || now;
                const minutesPassed = (now - lastUpdate) / (1000 * 60);
                
                // Passive recovery: 1 stamina per 5 minutes (12 per hour)
                const staminaGained = Math.floor(minutesPassed / 5);
                
                State.user.stamina = Math.min(
                    this.getMaxStamina(),
                    State.user.stamina + staminaGained
                );
                
                State.user.lastStaminaUpdate = now;
                saveState();
                
                // Update stamina every minute
                this.staminaInterval = setInterval(() => {
                    const currentTime = Date.now();
                    const minutesSinceLast = (currentTime - State.user.lastStaminaUpdate) / (1000 * 60);
                    
                    if (minutesSinceLast >= 5) {
                        State.user.stamina = Math.min(
                            this.getMaxStamina(),
                            State.user.stamina + 1
                        );
                        State.user.lastStaminaUpdate = currentTime;
                        this.render();
                    }
                }, 60000);
            },

            initStrengthSystem() {
                const now = Date.now();
                const lastCheck = State.user.lastStrengthCheck || now;
                const daysSinceLastCheck = (now - lastCheck) / (1000 * 60 * 60 * 24);
                
                // Update strength daily
                if (daysSinceLastCheck >= 1) {
                    this.updateStrength();
                    State.user.lastStrengthCheck = now;
                    saveState();
                }
                
                // Check strength every hour
                setInterval(() => {
                    const currentTime = Date.now();
                    const daysSince = (currentTime - State.user.lastStrengthCheck) / (1000 * 60 * 60 * 24);
                    
                    if (daysSince >= 1) {
                        this.updateStrength();
                        State.user.lastStrengthCheck = currentTime;
                        saveState();
                    }
                }, 3600000);
            },

            renderHistory() {
                drawHistoryChart();
                drawOverallRing();
                renderCalendar();
            },

            getMaxStamina() {
                // Base max stamina + strength bonus (10 per strength point)
                return 100 + (State.user.strength * 10);
            },

            getStaminaCost(diff) {
                const baseCost = {
                    'easy': 10,
                    'medium': 20,
                    'hard': 40
                };
                
                const base = baseCost[diff] || 10;
                
                // Strength reduces stamina cost by 10% per strength point
                const strengthReduction = State.user.strength * 0.1;
                const reduction = Math.min(0.5, strengthReduction);
                
                return Math.max(5, Math.floor(base * (1 - reduction)));
            },

            getHabitXP(diff) {
                const xpMap = {
                    'easy': 10,
                    'medium': 25,
                    'hard': 50
                };
                
                const baseXP = xpMap[diff] || 10;
                
                // Strength gives +5% XP per strength point
                const strengthBonus = State.user.strength * 0.05;
                
                // Recruit bonus (5% per recruit)
                const recruitBonus = State.user.recruits * 0.05;
                
                const totalBonus = strengthBonus + recruitBonus;
                const finalXP = Math.floor(baseXP * (1 + totalBonus));
                
                return finalXP;
            },

            updateStrength() {
                const today = getLocalDateString();
                const yesterday = getYesterdayDateString();
                
                // Check if user completed any habits yesterday
                let completedYesterday = false;
                State.habits.forEach(habit => {
                    if (habit.completedDates.includes(yesterday)) {
                        completedYesterday = true;
                    }
                });
                
                if (completedYesterday) {
                    // Increase strength for consistency
                    State.user.strength = Math.min(100, State.user.strength + 1);
                    State.user.consecutiveInactiveDays = 0;
                } else {
                    // Decrease strength for inactivity
                    State.user.consecutiveInactiveDays++;
                    
                    if (State.user.consecutiveInactiveDays >= 3) {
                        State.user.strength = Math.max(1, State.user.strength - 1);
                        State.user.consecutiveInactiveDays = 0;
                    }
                }
            },

            activeRecovery(type) {
                const now = Date.now();
                const lastRecovery = State.user.lastRecoveryTime || 0;
                const hoursSinceLastRecovery = (now - lastRecovery) / (1000 * 60 * 60);
                
                if (type === 'easy') {
                    // Quick Rest: Complete an easy habit to recover stamina
                    const easyHabit = State.habits.find(h => h.diff === 'easy' && h.days.includes(new Date().getDay()));
                    
                    if (easyHabit) {
                        const todayStr = getLocalDateString();
                        
                        if (!easyHabit.completedDates.includes(todayStr)) {
                            // Complete the easy habit for recovery
                            easyHabit.completedDates.push(todayStr);
                            this.recalcStreak(easyHabit);
                            
                            // Gain stamina instead of XP
                            const staminaGain = 15;
                            State.user.stamina = Math.min(this.getMaxStamina(), State.user.stamina + staminaGain);
                            
                            // Update activity log
                            if (!State.activityLog[todayStr]) {
                                State.activityLog[todayStr] = 0;
                            }
                            State.activityLog[todayStr]++;
                            
                            AudioSys.play('recover');
                            saveState();
                        } else {
                            alert("You've already completed an easy habit today for recovery!");
                        }
                    } else {
                        alert("No easy habits scheduled for today!");
                    }
                } else if (type === 'meditate') {
                    // Meditation: Direct stamina recovery (once per 4 hours)
                    if (hoursSinceLastRecovery < 4) {
                        const hoursLeft = (4 - hoursSinceLastRecovery).toFixed(1);
                        alert(`Meditation available in ${hoursLeft} hours`);
                        return;
                    }
                    
                    const meditationStamina = 20;
                    State.user.stamina = Math.min(this.getMaxStamina(), State.user.stamina + meditationStamina);
                    State.user.lastRecoveryTime = now;
                    
                    AudioSys.play('recover');
                    saveState();
                }
            },

            openModal() {
                this.tempDays = [];
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected'));
                document.getElementById('habit-name').value = '';
                document.getElementById('habit-diff').selectedIndex = 1;
                document.getElementById('add-modal').classList.add('open');
            },

            closeModal(id = 'add-modal') { 
                document.getElementById(id).classList.remove('open'); 
            },

            toggleEveryday() {
                const allSelected = this.tempDays.length === 7;
                this.tempDays = [];
                document.querySelectorAll('.day-btn').forEach(btn => {
                    if (!allSelected) {
                        btn.classList.add('selected');
                        this.tempDays.push(parseInt(btn.dataset.day));
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            },

            saveHabit() {
                const name = document.getElementById('habit-name').value.trim();
                const diffSelect = document.getElementById('habit-diff');
                const diff = diffSelect.options[diffSelect.selectedIndex].value;
                
                if (!name) {
                    alert("Quest name required!");
                    return;
                }
                
                if (this.tempDays.length === 0) {
                    alert("Select at least one active day!");
                    return;
                }

                State.habits.push({
                    id: Date.now(),
                    title: name,
                    diff: diff,
                    days: [...this.tempDays].sort(),
                    completedDates: [],
                    streak: 0,
                    bestStreak: 0,
                    createdAt: new Date().toISOString()
                });
                
                this.closeModal();
                AudioSys.play('click');
                saveState();
            },

            toggleHabit(id) {
                const habit = State.habits.find(h => h.id === id);
                if(!habit) return;
                
                const today = new Date();
                const todayIndex = today.getDay();
                const todayStr = getLocalDateString();
                
                // Check if habit is active today
                if(!habit.days.includes(todayIndex)) {
                    alert("This quest is not active today!");
                    return;
                }
                
                // Check stamina with strength reduction
                const staminaCost = this.getStaminaCost(habit.diff);
                if(State.user.stamina < staminaCost && !habit.completedDates.includes(todayStr)) {
                    alert(`Insufficient stamina! Need ${staminaCost} stamina.`);
                    return;
                }
                
                if (habit.completedDates.includes(todayStr)) {
                    // Undo completion
                    habit.completedDates = habit.completedDates.filter(d => d !== todayStr);
                    this.recalcStreak(habit);
                    const xp = this.getHabitXP(habit.diff);
                    State.user.xp = Math.max(0, State.user.xp - xp);
                    State.user.totalCompleted = Math.max(0, State.user.totalCompleted - 1);
                    State.user.totalXp = Math.max(0, State.user.totalXp - xp);
                    State.user.stamina += staminaCost;
                    
                    // Update activity log
                    if (State.activityLog[todayStr]) {
                        State.activityLog[todayStr]--;
                        if (State.activityLog[todayStr] <= 0) {
                            delete State.activityLog[todayStr];
                        }
                    }
                    
                    // Reset sleep bonus availability
                    State.user.sleepBonusAvailable = true;
                } else {
                    // Complete habit
                    habit.completedDates.push(todayStr);
                    this.recalcStreak(habit);
                    const xp = this.getHabitXP(habit.diff);
                    State.user.xp += xp;
                    State.user.totalCompleted++;
                    State.user.totalXp += xp;
                    State.user.stamina -= staminaCost;
                    State.user.dailyCompletions++;
                    
                    AudioSys.play('click');
                    this.checkLevelUp();
                    
                    // Update activity log
                    if (!State.activityLog[todayStr]) {
                        State.activityLog[todayStr] = 0;
                    }
                    State.activityLog[todayStr]++;
                    
                    // Reset sleep bonus when active
                    State.user.sleepBonusAvailable = false;
                }
                
                saveState();
                this.renderHistory(); // Update history view
            },

            deleteHabit(id) {
                if(confirm("Delete this quest?")) {
                    State.habits = State.habits.filter(h => h.id !== id);
                    saveState();
                    this.renderHistory(); // Update history view
                }
            },

            recalcStreak(habit) {
                const dates = habit.completedDates.sort().reverse();
                const todayStr = getLocalDateString();
                const yesterdayStr = getYesterdayDateString();
                let streak = 0;
                
                if (dates.length > 0 && (dates[0] === todayStr || dates[0] === yesterdayStr)) {
                    streak = 1;
                    for(let i = 0; i < dates.length - 1; i++) {
                        const d1 = new Date(dates[i] + 'T00:00:00');
                        const d2 = new Date(dates[i + 1] + 'T00:00:00');
                        const diff = (d1 - d2) / (1000 * 60 * 60 * 24);
                        if (diff === 1) streak++;
                        else break;
                    }
                }
                habit.streak = streak;
                if (streak > habit.bestStreak) habit.bestStreak = streak;
            },

            checkLevelUp() {
                if(State.user.xp >= State.user.xpToNext) {
                    State.user.level++;
                    State.user.xp -= State.user.xpToNext;
                    State.user.xpToNext = Math.floor(State.user.xpToNext * 1.2);
                    State.user.maxStamina = this.getMaxStamina();
                    State.user.stamina = State.user.maxStamina;
                    State.user.strength += 2;
                    
                    // Add a free recruit on level up
                    State.user.recruits++;
                    State.recruits.push({
                        id: Date.now(),
                        level: 1,
                        type: this.getRecruitType(),
                        recruitedAt: new Date().toISOString()
                    });
                    
                    document.getElementById('level-msg').innerText = `You have reached Level ${State.user.level}`;
                    document.getElementById('level-reward').innerText = `+1 Recruit Added to your Army!`;
                    document.getElementById('level-modal').classList.add('open');
                    
                    AudioSys.play('levelup');
                    saveState();
                }
            },

            summonRecruit() {
                const cost = 100;
                if(State.user.xp >= cost) {
                    State.user.xp -= cost;
                    State.user.recruits++;
                    
                    State.recruits.push({
                        id: Date.now(),
                        level: 1,
                        type: this.getRecruitType(),
                        recruitedAt: new Date().toISOString()
                    });
                    
                    AudioSys.play('recruit');
                    saveState();
                    
                    alert(`Recruit trained successfully! You now have ${State.user.recruits} recruits.`);
                } else {
                    alert("Insufficient XP to train recruit! You need 100 XP.");
                }
            },

            getRecruitType() {
                const types = ['Soldier', 'Scout', 'Engineer', 'Medic', 'Leader'];
                return types[Math.floor(Math.random() * types.length)];
            },

            navigate(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                const viewEl = document.getElementById(viewId);
                if (viewEl) viewEl.classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const navs = document.querySelectorAll('.nav-btn');
                if(viewId === 'dashboard') navs[0].classList.add('active');
                if(viewId === 'timer') navs[1].classList.add('active');
                if(viewId === 'history') { 
                    navs[2].classList.add('active'); 
                    setTimeout(() => {
                        this.renderHistory(); // Render history when navigated to
                    }, 100);
                }
                if(viewId === 'army') {
                    navs[3].classList.add('active');
                    this.renderArmy();
                }
                
                document.getElementById('sidebar').classList.remove('open');
            },

            renderArmy() {
                const grid = document.getElementById('recruits-grid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                State.recruits.forEach((recruit, index) => {
                    const card = document.createElement('div');
                    card.className = 'soldier-card';
                    card.innerHTML = `
                        <div class="soldier-icon">üí™</div>
                        <div class="soldier-name">${recruit.type} #${index + 1}</div>
                        <div class="soldier-level">Level ${recruit.level}</div>
                    `;
                    grid.appendChild(card);
                });
                
                // Add empty slots
                const emptySlots = Math.max(0, 12 - State.recruits.length);
                for(let i = 0; i < emptySlots; i++) {
                    const card = document.createElement('div');
                    card.className = 'soldier-card';
                    card.style.opacity = '0.3';
                    card.innerHTML = `
                        <div class="soldier-icon">‚≠ï</div>
                        <div class="soldier-name">Empty Slot</div>
                        <div class="soldier-level">Train to fill</div>
                    `;
                    grid.appendChild(card);
                }
                
                document.getElementById('total-recruits-army').innerText = State.user.recruits;
            },

            render() {
                // Update level and XP
                document.getElementById('header-level').innerText = 'LVL ' + State.user.level;
                document.getElementById('xp-text').innerText = `${State.user.xp} / ${State.user.xpToNext} XP`;
                document.getElementById('xp-bar').style.width = `${(State.user.xp / State.user.xpToNext) * 100}%`;
                
                // Calculate stats
                const best = State.habits.reduce((max, h) => Math.max(max, h.bestStreak), 0);
                document.getElementById('best-streak').innerText = best;
                document.getElementById('total-quests').innerText = State.user.totalCompleted;
                document.getElementById('total-recruits').innerText = State.user.recruits;
                document.getElementById('recruits-count').innerText = State.user.recruits;
                
                // Update stamina
                const maxStamina = this.getMaxStamina();
                document.getElementById('current-stamina').innerText = Math.floor(State.user.stamina);
                document.getElementById('max-stamina').innerText = maxStamina;
                document.getElementById('stamina-bar').style.width = `${(State.user.stamina / maxStamina) * 100}%`;
                
                // Update stamina recovery info
                const reductionPercent = Math.min(50, State.user.strength * 10);
                document.getElementById('strength-bonus').innerText = `-${reductionPercent}% cost`;
                
                // Update strength
                document.getElementById('strength-value').innerText = State.user.strength;
                const strengthPercent = Math.min(100, State.user.strength);
                document.getElementById('strength-bar').style.width = `${strengthPercent}%`;
                
                // Update strength change indicator
                const today = getLocalDateString();
                let todayCompletions = 0;
                State.habits.forEach(habit => {
                    if (habit.completedDates.includes(today)) {
                        todayCompletions++;
                    }
                });
                
                const strengthChange = todayCompletions > 0 ? `+${todayCompletions} today` : `-${State.user.consecutiveInactiveDays} days inactive`;
                document.getElementById('strength-change').innerText = strengthChange;
                
                // Update recruit button
                const summonBtn = document.getElementById('summon-btn');
                if (summonBtn) {
                    summonBtn.innerText = `Train Recruit (100 XP)`;
                    summonBtn.disabled = State.user.xp < 100;
                }
                
                const trainBtn = document.getElementById('train-recruit-btn');
                if (trainBtn) {
                    trainBtn.innerHTML = `‚ö° Train Recruit (Cost: 100 XP)<br><small>Army Size: ${State.user.recruits}</small>`;
                    trainBtn.disabled = State.user.xp < 100;
                }
                
                // Update recovery buttons
                const easyBtn = document.getElementById('easy-recovery');
                if (easyBtn) {
                    const hasEasyHabit = State.habits.some(h => h.diff === 'easy' && h.days.includes(new Date().getDay()));
                    easyBtn.disabled = !hasEasyHabit;
                }
                
                // Render today's habits
                const todayIndex = new Date().getDay();
                const todayStr = getLocalDateString();
                const listContainer = document.getElementById('habit-list-container');
                const sidebarList = document.getElementById('sidebar-habit-list');
                
                if (listContainer) listContainer.innerHTML = '';
                if (sidebarList) sidebarList.innerHTML = '';
                
                let currentStreakTotal = 0;
                let hasHabitsToday = false;
                
                State.habits.forEach(h => {
                    const isTodayActive = h.days.includes(todayIndex);
                    const isDone = h.completedDates.includes(todayStr);
                    const staminaCost = this.getStaminaCost(h.diff);
                    const xpValue = this.getHabitXP(h.diff);
                    
                    if(isDone) currentStreakTotal = Math.max(currentStreakTotal, h.streak);
                    
                    // Sidebar: Show all habits
                    if (sidebarList) {
                        const sbItem = document.createElement('div');
                        sbItem.className = 'sidebar-habit-item';
                        sbItem.innerHTML = `
                            <span>${h.title}</span>
                            <span style="color: ${isTodayActive ? 'var(--primary)' : 'var(--text-dim)'}; font-size: 0.8rem;">
                                ${isTodayActive ? 'Active' : 'Inactive'}
                            </span>
                            <span class="sb-del" onclick="App.deleteHabit(${h.id})">√ó</span>
                        `;
                        sidebarList.appendChild(sbItem);
                    }
                    
                    // Dashboard: Only show today's active habits
                    if(isTodayActive && listContainer) {
                        hasHabitsToday = true;
                        const card = document.createElement('div');
                        card.className = `habit-card ${isDone ? 'completed' : ''}`;
                        card.innerHTML = `
                            <div class="habit-left">
                                <div class="check-btn" onclick="App.toggleHabit(${h.id})"></div>
                                <div>
                                    <div class="habit-title">${h.title}</div>
                                    <div class="habit-meta">
                                        <span class="difficulty-badge difficulty-${h.diff}">${h.diff.toUpperCase()}</span>
                                        <span>üî• ${h.streak}</span>
                                        <span>‚ö° ${staminaCost} Stamina</span>
                                        <span>‚≠ê ${xpValue} XP</span>
                                    </div>
                                </div>
                            </div>
                            <button class="delete-btn" onclick="App.deleteHabit(${h.id})">√ó</button>
                        `;
                        listContainer.appendChild(card);
                    }
                });
                
                document.getElementById('curr-streak').innerText = currentStreakTotal;
                
                if(!hasHabitsToday && listContainer) {
                    listContainer.innerHTML = `
                        <div style="text-align:center; color:#333; padding:2rem;">
                            No missions scheduled for today.
                        </div>
                    `;
                }
            }
        };

        // --- TIMER MODULE ---
        const Timer = {
            mode: 'pomodoro',
            running: false,
            interval: null,
            raf: null,
            stopwatchTime: 0,
            stopwatchStartTime: 0,
            pomodoroTime: 25 * 60,
            pomodoroState: 'FOCUS',
            pomodoroCycle: 1,
            totalCycles: 4,
            laps: [],
            lapTimes: [],
            circumference: 2 * Math.PI * 130,

            init() {
                this.updateDisplay();
                this.updateModeDescription();
            },

            setMode(mode) {
                this.stop();
                this.mode = mode;
                this.pomodoroCycle = 1;
                
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                if(mode === 'pomodoro') {
                    document.querySelectorAll('.mode-btn')[0].classList.add('active');
                    document.getElementById('btn-lap').disabled = true;
                    const lapsDisplay = document.getElementById('laps-display');
                    if (lapsDisplay) lapsDisplay.classList.remove('active');
                } else {
                    document.querySelectorAll('.mode-btn')[1].classList.add('active');
                    document.getElementById('btn-lap').disabled = false;
                }
                
                this.reset();
                this.updateModeDescription();
            },

            toggle() {
                if (this.running) {
                    this.pause();
                } else {
                    this.start();
                }
            },

            start() {
                this.running = true;
                const startBtn = document.getElementById('btn-start');
                if (startBtn) startBtn.innerText = "Pause";
                
                const timerProgress = document.getElementById('timer-progress');
                if (timerProgress) timerProgress.style.stroke = 'var(--primary)';
                
                if (this.mode === 'pomodoro') {
                    const startTime = Date.now() - ((25 * 60 - this.pomodoroTime) * 1000);
                    
                    this.interval = setInterval(() => {
                        const currentTime = Date.now();
                        const elapsedSeconds = Math.floor((currentTime - startTime) / 1000);
                        this.pomodoroTime = Math.max(0, (25 * 60) - elapsedSeconds);
                        
                        if (this.pomodoroTime <= 0) {
                            this.pomodoroComplete();
                        }
                        this.updateDisplay();
                    }, 100);
                } else {
                    if (this.stopwatchStartTime === 0) {
                        this.stopwatchStartTime = Date.now() - this.stopwatchTime;
                    }
                    
                    const updateStopwatch = () => {
                        if (!this.running) return;
                        this.stopwatchTime = Date.now() - this.stopwatchStartTime;
                        this.updateDisplay();
                        this.raf = requestAnimationFrame(updateStopwatch);
                    };
                    this.raf = requestAnimationFrame(updateStopwatch);
                }
            },

            pause() {
                clearInterval(this.interval);
                cancelAnimationFrame(this.raf);
                this.running = false;
                const startBtn = document.getElementById('btn-start');
                if (startBtn) startBtn.innerText = "Resume";
                
                const timerProgress = document.getElementById('timer-progress');
                if (timerProgress) timerProgress.style.stroke = '#333';
            },

            stop() {
                this.pause();
            },

            reset() {
                this.stop();
                
                if (this.mode === 'pomodoro') {
                    this.pomodoroState = 'FOCUS';
                    this.pomodoroTime = 25 * 60;
                    this.pomodoroCycle = 1;
                    const timerStatus = document.getElementById('timer-status');
                    if (timerStatus) timerStatus.innerText = 'FOCUS';
                    
                    const timerCycle = document.getElementById('timer-cycle');
                    if (timerCycle) timerCycle.innerText = 'Cycle: 1/4';
                    
                    const startBtn = document.getElementById('btn-start');
                    if (startBtn) startBtn.innerText = "Start";
                } else {
                    this.stopwatchTime = 0;
                    this.stopwatchStartTime = 0;
                    this.laps = [];
                    this.lapTimes = [];
                    const lapsDisplay = document.getElementById('laps-display');
                    if (lapsDisplay) {
                        lapsDisplay.innerHTML = '<div class="laps-header">LAP TIMES</div>';
                    }
                    const timerStatus = document.getElementById('timer-status');
                    if (timerStatus) timerStatus.innerText = 'STOPWATCH';
                    
                    const startBtn = document.getElementById('btn-start');
                    if (startBtn) startBtn.innerText = "Start";
                }
                this.updateDisplay();
            },

            pomodoroComplete() {
                this.stop();
                AudioSys.play('complete');
                
                if (this.pomodoroState === 'FOCUS') {
                    State.timerStats.pomodoroCompleted++;
                    State.timerStats.totalFocusTime += 25;
                    
                    if (this.pomodoroCycle === this.totalCycles) {
                        this.pomodoroState = 'LONG BREAK';
                        this.pomodoroTime = 20 * 60;
                        const timerStatus = document.getElementById('timer-status');
                        if (timerStatus) timerStatus.innerText = 'LONG BREAK';
                    } else {
                        this.pomodoroState = 'SHORT BREAK';
                        this.pomodoroTime = 5 * 60;
                        const timerStatus = document.getElementById('timer-status');
                        if (timerStatus) timerStatus.innerText = 'SHORT BREAK';
                    }
                } else {
                    if (this.pomodoroState === 'LONG BREAK') {
                        this.pomodoroCycle = 0;
                    }
                    
                    this.pomodoroCycle++;
                    this.pomodoroState = 'FOCUS';
                    this.pomodoroTime = 25 * 60;
                    const timerStatus = document.getElementById('timer-status');
                    if (timerStatus) timerStatus.innerText = 'FOCUS';
                }
                
                const timerCycle = document.getElementById('timer-cycle');
                if (timerCycle) timerCycle.innerText = `Cycle: ${this.pomodoroCycle}/${this.totalCycles}`;
                saveState();
                this.updateDisplay();
            },

            lap() {
                if (this.running && this.mode === 'stopwatch') {
                    this.laps.push(this.stopwatchTime);
                    this.lapTimes.push(this.stopwatchTime);
                    
                    const container = document.getElementById('laps-display');
                    if (!container) return;
                    
                    container.classList.add('active');
                    
                    const lapNum = this.laps.length;
                    const lapTime = this.formatTime(this.stopwatchTime);
                    
                    let diffText = '';
                    if (this.laps.length > 1) {
                        const prevLap = this.laps[this.laps.length - 2];
                        const diff = this.stopwatchTime - prevLap;
                        diffText = diff > 0 ? `+${this.formatTime(diff, true)}` : this.formatTime(diff, true);
                    }
                    
                    const lapItem = document.createElement('div');
                    lapItem.className = 'lap-item';
                    lapItem.innerHTML = `
                        <span class="lap-num">Lap ${lapNum}</span>
                        <span class="lap-time">${lapTime}</span>
                        ${diffText ? `<span class="lap-diff">${diffText}</span>` : ''}
                    `;
                    
                    container.appendChild(lapItem);
                    container.scrollTop = container.scrollHeight;
                }
            },

            formatTime(ms, showMs = false) {
                const totalSeconds = Math.floor(ms / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const milliseconds = Math.floor((ms % 1000) / 10);
                
                if (showMs) {
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
                }
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },

            updateDisplay() {
                const timerText = document.getElementById('timer-text');
                const timerProgress = document.getElementById('timer-progress');
                
                if (!timerText || !timerProgress) return;
                
                if (this.mode === 'pomodoro') {
                    const minutes = Math.floor(this.pomodoroTime / 60);
                    const seconds = this.pomodoroTime % 60;
                    timerText.innerText = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    const totalTime = 25 * 60;
                    const progress = ((totalTime - this.pomodoroTime) / totalTime) * this.circumference;
                    timerProgress.style.strokeDashoffset = this.circumference - progress;
                    
                } else {
                    timerText.innerText = this.formatTime(this.stopwatchTime);
                    timerProgress.style.strokeDashoffset = 0;
                }
            },

            updateModeDescription() {
                const desc = document.getElementById('mode-description');
                if (!desc) return;
                
                if (this.mode === 'pomodoro') {
                    desc.innerHTML = '<span>25 min focus, 5 min break. Repeat 4 cycles ‚Üí 20 min long break.</span>';
                } else {
                    desc.innerHTML = '<span>Stopwatch with lap timing.</span>';
                }
            }
        };

        // --- INITIALIZE APP ---
        document.addEventListener('DOMContentLoaded', function() {
            App.init();
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }
        
        // Redraw chart on window resize
        window.addEventListener('resize', function() {
            if (document.getElementById('history').classList.contains('active')) {
                App.renderHistory();
            }
        });
    </script>

</body>
    </html>
