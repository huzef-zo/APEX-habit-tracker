<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>APEX | System</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #111111;
            --primary: #00f0ff;
            --text-main: #e0e0e0;
            --text-dim: #666;
            --danger: #ff003c;
            --success: #00ff9d;
            --border: 1px solid #333;
            
            /* Heatmap Colors */
            --heat-0: #161b22;
            --heat-1: #0e4429;
            --heat-2: #006d32;
            --heat-3: #26a641;
            --heat-4: #39d353;

            --font-display: 'Courier New', Courier, monospace;
            --font-ui: system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- INTRO ANIMATION --- */
        #intro-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease-out;
        }
        .logo-anim { font-family: var(--font-display); font-size: 4rem; font-weight: 900; color: var(--primary); letter-spacing: 10px; margin-bottom: 2rem; animation: glitch 2s infinite; }
        .slogan-anim { font-family: var(--font-display); font-size: 1.2rem; color: var(--text-dim); opacity: 0; transform: translateY(20px); animation: fadeUp 1.5s forwards 0.5s; letter-spacing: 3px; }

        @keyframes glitch {
            0% { transform: translate(0); text-shadow: 0 0 20px var(--primary); }
            20% { transform: translate(-2px, 2px); text-shadow: -2px 0 var(--danger); }
            40% { transform: translate(2px, -2px); text-shadow: 2px 0 var(--primary); }
            60% { transform: translate(0); } 100% { transform: translate(0); }
        }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

        /* --- LAYOUT --- */
        #app-container { display: flex; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s; }
        #app-container.visible { opacity: 1; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; background: var(--panel-bg); border-right: var(--border);
            display: flex; flex-direction: column; padding: 1.5rem; z-index: 10; flex-shrink: 0;
            overflow-y: auto;
        }
        .sidebar-brand { font-family: var(--font-display); font-weight: bold; color: var(--primary); font-size: 1.5rem; margin-bottom: 2rem; letter-spacing: -1px; }
        
        .nav-btn {
            background: none; border: none; color: var(--text-dim); padding: 0.8rem;
            text-align: left; cursor: pointer; font-family: var(--font-display);
            font-size: 0.9rem; transition: 0.2s; border-radius: 4px; margin-bottom: 0.2rem;
        }
        .nav-btn:hover { background: #1a1a1a; color: var(--text-main); }
        .nav-btn.active { background: rgba(0, 240, 255, 0.1); color: var(--primary); border-left: 3px solid var(--primary); }

        /* Sidebar Habit List */
        .sidebar-section-title { font-size: 0.7rem; color: #444; margin: 1.5rem 0 0.5rem; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar-habit-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px; font-size: 0.85rem; color: #ccc; background: #161616;
            margin-bottom: 4px; border-radius: 4px; transition: 0.2s;
        }
        .sidebar-habit-item:hover { background: #222; }
        .sb-del { color: #444; cursor: pointer; font-size: 1.1rem; }
        .sb-del:hover { color: var(--danger); }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 2rem; max-width: 1000px; margin: 0 auto; width: 100%; }

        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD COMPONENTS --- */
        .xp-section { margin-bottom: 2rem; text-align: center; }
        .level-badge { font-family: var(--font-display); color: var(--primary); font-size: 0.9rem; margin-bottom: 0.5rem; display: block; }
        .xp-track { width: 100%; height: 12px; background: #222; border-radius: 6px; overflow: hidden; border: 1px solid #333; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--panel-bg), var(--primary)); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 15px rgba(0, 240, 255, 0.3); }
        .xp-text { font-family: var(--font-display); font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; display: block; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; background: var(--panel-bg); padding: 1.5rem; border-radius: 8px; border: var(--border); }
        .stat-box { text-align: center; }
        .stat-val { display: block; font-family: var(--font-display); font-size: 1.8rem; color: var(--text-main); font-weight: bold; }
        .stat-lbl { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .stat-val.highlight { color: var(--primary); text-shadow: 0 0 10px rgba(0, 240, 255, 0.3); }

        .habit-list { display: flex; flex-direction: column; gap: 1rem; }
        .habit-card { background: var(--panel-bg); border: var(--border); padding: 1.2rem; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .habit-card:hover { transform: translateX(5px); border-color: #444; }
        .habit-card.completed { border-left: 4px solid var(--success); background: rgba(0, 255, 157, 0.03); }
        .habit-left { display: flex; align-items: center; gap: 1rem; flex: 1; }
        .check-btn { width: 24px; height: 24px; border: 2px solid #555; border-radius: 50%; background: transparent; cursor: pointer; display: grid; place-items: center; }
        .habit-card.completed .check-btn { border-color: var(--success); background: rgba(0, 255, 157, 0.2); }
        .habit-card.completed .check-btn::after { content: '‚úì'; color: var(--success); font-size: 0.8rem; }
        .habit-title { font-weight: 600; font-size: 1.1rem; }
        .habit-meta { font-size: 0.8rem; color: var(--text-dim); display: flex; gap: 10px; margin-top: 4px; }
        .delete-btn { background: none; border: none; color: #333; cursor: pointer; font-size: 1.2rem; padding: 0.5rem; transition: 0.2s; }
        .delete-btn:hover { color: var(--danger); }

        #fab { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; background: var(--primary); color: #000; border-radius: 50%; border: none; font-size: 2rem; cursor: pointer; box-shadow: 0 0 20px rgba(0, 240, 255, 0.4); display: flex; align-items: center; justify-content: center; transition: 0.3s; z-index: 100; }
        #fab:hover { transform: scale(1.1) rotate(90deg); background: #fff; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 200; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-box { background: var(--panel-bg); width: 90%; max-width: 400px; padding: 2rem; border: 1px solid #333; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.open .modal-box { transform: scale(1); }
        .input-field { width: 100%; padding: 0.8rem; background: #000; border: 1px solid #333; color: #fff; margin-bottom: 1rem; border-radius: 4px; }
        .day-selector { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .day-btn { width: 32px; height: 32px; border: 1px solid #333; background: #000; color: #666; border-radius: 4px; cursor: pointer; display: grid; place-items: center; font-size: 0.8rem; }
        .day-btn.selected { background: var(--primary); color: #000; }
        .btn-primary { width: 100%; background: var(--primary); color: #000; border: none; padding: 1rem; font-weight: bold; border-radius: 4px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        /* --- TIMER --- */
        .timer-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; }
        .timer-modes { display: flex; gap: 1rem; margin-bottom: 2rem; background: #111; padding: 0.3rem; border-radius: 20px; }
        .mode-btn { padding: 0.5rem 1.5rem; border-radius: 15px; border: none; background: transparent; color: #666; cursor: pointer; font-family: var(--font-display); font-size: 0.8rem; transition: 0.2s; }
        .mode-btn.active { background: var(--primary); color: #000; }
        
        .timer-circle { width: 250px; height: 250px; border-radius: 50%; border: 4px solid #222; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 2rem; }
        .timer-ring-svg { transform: rotate(-90deg); width: 250px; height: 250px; }
        .timer-circle circle { fill: transparent; stroke-width: 4; }
        .timer-bg { stroke: #222; }
        .timer-progress { stroke: var(--primary); transition: stroke-dashoffset 0.1s linear; }
        .timer-display { font-family: var(--font-display); font-size: 4rem; font-weight: 900; font-variant-numeric: tabular-nums; }
        .timer-label { position: absolute; bottom: 60px; color: var(--text-dim); font-size: 0.9rem; text-transform: uppercase; }
        .timer-controls { display: flex; gap: 1rem; }
        .timer-btn { padding: 0.8rem 2rem; background: var(--panel-bg); border: 1px solid #333; color: #fff; border-radius: 4px; cursor: pointer; font-family: var(--font-display); transition: 0.2s; }
        .timer-btn:hover { border-color: var(--primary); }
        .timer-btn.active { background: var(--primary); color: #000; }

        /* LAPS (Stopwatch) */
        .laps-container {
            width: 320px; height: 150px; overflow-y: auto;
            background: #111; border: 1px solid #333; border-radius: 8px;
            margin-bottom: 1rem; padding: 10px; display: none;
        }
        .laps-container.active { display: block; }
        .lap-item { display: flex; justify-content: space-between; font-family: var(--font-display); font-size: 0.9rem; border-bottom: 1px solid #222; padding: 5px 0; color: #888; }
        .lap-item:last-child { border-bottom: none; }
        .lap-num { color: var(--primary); }

        /* --- HISTORY / CHRONICLES --- */
        .history-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .chart-card { background: var(--panel-bg); border: 1px solid #333; border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; }
        .chart-title { font-size: 0.9rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 1rem; width: 100%; display: flex; justify-content: space-between; }
        
        .graph-container { width: 100%; height: 200px; position: relative; }
        canvas { width: 100%; height: 100%; }

        .ring-container { position: relative; width: 180px; height: 180px; }
        .ring-svg { transform: rotate(-90deg); width: 180px; height: 180px; }
        .ring-bg { stroke: #222; fill: none; stroke-width: 8; }
        .ring-fill { stroke: var(--primary); fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1s ease; filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.3)); }
        .ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .ring-percent { font-size: 2.5rem; font-weight: 900; font-family: var(--font-display); color: #fff; }
        .ring-label { font-size: 0.8rem; color: var(--text-dim); }

        /* --- HEATMAP --- */
        .heatmap-wrapper { background: var(--panel-bg); border: 1px solid #333; border-radius: 12px; padding: 1.5rem; overflow-x: auto; }
        .heatmap-container { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); /* 7 Days */
            gap: 5px; 
            min-width: 600px; /* Ensure it doesn't squash too much */
        }
        .heat-cell { 
            width: 40px; height: 40px; /* Bigger Cells */
            border-radius: 6px; 
            background: var(--heat-0); 
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-display);
            font-size: 0.9rem;
            color: #333; /* Dark text for empty cells */
            position: relative;
            transition: transform 0.2s;
        }
        .heat-cell:hover { transform: scale(1.1); z-index: 10; border: 1px solid #fff; }
        
        .heat-cell span { pointer-events: none; }
        
        .heat-cell[data-lvl="1"] { background: var(--heat-1); color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .heat-cell[data-lvl="2"] { background: var(--heat-2); color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .heat-cell[data-lvl="3"] { background: var(--heat-3); color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .heat-cell[data-lvl="4"] { background: var(--heat-4); color: #000; font-weight: bold; }

        /* Responsive */
        @media(max-width: 768px) {
            .history-grid { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: -100%; height: 100%; transition: 0.3s; width: 80%; }
            .sidebar.open { left: 0; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
            .mobile-menu-btn { display: block; position: absolute; top: 1.5rem; left: 1.5rem; background: none; border: none; color: #fff; font-size: 1.5rem; z-index: 5; }
            .scroll-area { padding: 4rem 1rem 2rem 1rem; }
        }
        @media(min-width: 769px) { .mobile-menu-btn { display: none; } }
    </style>
</head>
<body>

    <!-- Intro -->
    <div id="intro-overlay">
        <div class="logo-anim">APEX</div>
        <div class="slogan-anim">Consistency Compounds</div>
    </div>

    <!-- Add Habit Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal-box">
            <h3 style="font-family: var(--font-display); margin-bottom: 1rem; color: var(--primary);">NEW QUEST</h3>
            <input type="text" id="habit-name" class="input-field" placeholder="Quest Name..." autocomplete="off">
            
            <label style="font-size: 0.8rem; color: #666; margin-bottom: 5px; display: block;">Difficulty (XP)</label>
            <select id="habit-diff" class="input-field">
                <option value="easy">Easy (+10 XP)</option>
                <option value="medium" selected>Medium (+25 XP)</option>
                <option value="hard">Hard (+50 XP)</option>
            </select>

            <label style="font-size: 0.8rem; color: #666; margin-bottom: 10px; display: block;">Repeat On:</label>
            <div class="day-selector" id="day-selector">
                <button class="day-btn" data-day="0">S</button>
                <button class="day-btn" data-day="1">M</button>
                <button class="day-btn" data-day="2">T</button>
                <button class="day-btn" data-day="3">W</button>
                <button class="day-btn" data-day="4">T</button>
                <button class="day-btn" data-day="5">F</button>
                <button class="day-btn" data-day="6">S</button>
            </div>
            <button style="font-size: 0.8rem; color: var(--primary); background: none; border: none; cursor: pointer; text-decoration: underline; margin-bottom: 1rem; display: block;" onclick="App.toggleEveryday()">Select Every Day</button>

            <button class="btn-primary" onclick="App.saveHabit()">Initialize Quest</button>
            <button style="background: none; border: none; color: #666; width: 100%; margin-top: 1rem; cursor: pointer;" onclick="App.closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div class="modal-overlay" id="level-modal">
        <div class="modal-box" style="text-align: center;">
            <h1 style="color: var(--primary); font-family: var(--font-display); font-size: 3rem; margin-bottom: 1rem;">LEVEL UP</h1>
            <p style="margin-bottom: 2rem; color: #fff;" id="level-msg">You have reached Level 2</p>
            <button class="btn-primary" onclick="App.closeModal('level-modal')">ACKNOWLEDGE</button>
        </div>
    </div>

    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- App -->
    <div id="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">APEX</div>
            <button class="nav-btn active" onclick="App.navigate('dashboard')">üè∞ Dashboard</button>
            <button class="nav-btn" onclick="App.navigate('timer')">‚è≥ Time Chamber</button>
            <button class="nav-btn" onclick="App.navigate('history')">üìú Chronicles</button>

            <div class="sidebar-section-title">Recruits</div>
            <div id="sidebar-habit-list"></div>
        </aside>

        <!-- Main -->
        <main class="main-content">
            <div class="scroll-area">
                
                <!-- VIEW: DASHBOARD -->
                <section id="dashboard" class="view-section active">
                    <div class="xp-section">
                        <span class="level-badge" id="header-level">LVL 1</span>
                        <div class="xp-track"><div class="xp-fill" id="xp-bar"></div></div>
                        <span class="xp-text" id="xp-text">0 / 100 XP</span>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box"><span class="stat-val highlight" id="best-streak">0</span><span class="stat-lbl">Best Streak</span></div>
                        <div class="stat-box"><span class="stat-val" id="curr-streak">0</span><span class="stat-lbl">Current Streak</span></div>
                        <div class="stat-box"><span class="stat-val" id="total-quests">0</span><span class="stat-lbl">Total Quests</span></div>
                    </div>

                    <h3 style="font-family: var(--font-display); color: var(--text-dim); margin-bottom: 1rem; border-bottom: 1px solid #333; padding-bottom: 0.5rem;">Today's Missions</h3>
                    <div class="habit-list" id="habit-list-container"></div>
                    <div style="height: 80px;"></div>
                </section>

                <!-- VIEW: TIMER -->
                <section id="timer" class="view-section">
                    <div class="timer-wrapper">
                        <div class="timer-modes">
                            <button class="mode-btn active" onclick="Timer.setMode('pomodoro')">Pomodoro</button>
                            <button class="mode-btn" onclick="Timer.setMode('stopwatch')">Stopwatch</button>
                        </div>

                        <!-- Laps Container (Stopwatch Only) -->
                        <div id="laps-display" class="laps-container"></div>

                        <div class="timer-circle">
                            <svg class="timer-ring-svg">
                                <circle class="timer-bg" cx="125" cy="125" r="120"></circle>
                                <circle class="timer-progress" id="timer-progress" cx="125" cy="125" r="120" stroke-dasharray="754" stroke-dashoffset="0"></circle>
                            </svg>
                            <div style="text-align: center;">
                                <div class="timer-display" id="timer-text">25:00</div>
                                <div class="timer-label" id="timer-status">FOCUS</div>
                            </div>
                        </div>
                        <div class="timer-controls">
                            <button class="timer-btn active" id="btn-start" onclick="Timer.toggle()">Start</button>
                            <button class="timer-btn" id="btn-lap" onclick="Timer.lap()">Lap</button>
                            <button class="timer-btn" onclick="Timer.reset()">Reset</button>
                        </div>
                    </div>
                </section>

                <!-- VIEW: HISTORY -->
                <section id="history" class="view-section">
                    <h2 style="font-family: var(--font-display); color: var(--primary); margin-bottom: 1.5rem;">Chronicles</h2>
                    
                    <div class="history-grid">
                        <!-- Left: Activity Graph -->
                        <div class="chart-card">
                            <div class="chart-title">
                                Activity Trend (30 Days)
                                <span id="graph-pct" style="color:var(--primary); font-weight:bold; font-family: var(--font-display);">0%</span>
                            </div>
                            <div class="graph-container">
                                <canvas id="activityCanvas"></canvas>
                            </div>
                        </div>
                        
                        <!-- Right: Consistency Ring -->
                        <div class="chart-card">
                            <div class="chart-title">Monthly Consistency</div>
                            <div class="ring-container">
                                <svg class="ring-svg" viewBox="0 0 180 180">
                                    <circle class="ring-bg" cx="90" cy="90" r="80"></circle>
                                    <circle class="ring-fill" id="consistency-ring" cx="90" cy="90" r="80" stroke-dasharray="502" stroke-dashoffset="502"></circle>
                                </svg>
                                <div class="ring-text">
                                    <div class="ring-percent" id="consistency-pct">0%</div>
                                    <div class="ring-label">Completed</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom: Heatmap -->
                    <div class="heatmap-wrapper">
                        <div class="chart-title" style="margin-bottom: 1rem;">Activity Map (Current Month)</div>
                        <div class="heatmap-container" id="heatmap-grid">
                            <!-- Grid populated by JS -->
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <button id="fab" onclick="App.openModal()">+</button>

    <script>
        // --- AUDIO SYSTEM ---
        const AudioSys = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            play(type) {
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const now = this.ctx.currentTime;
                if (type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                } else if (type === 'levelup') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.linearRampToValueAtTime(800, now + 0.5);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 1.5);
                    osc.start(now); osc.stop(now + 1.5);
                }
            }
        };

        // --- STATE ---
        const STORAGE_KEY = 'apex_v6';
        const defaultState = {
            user: { level:1, xp: 0, xpToNext: 100, totalCompleted: 0 },
            habits: [],
            activityLog: {}
        };
        let State = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState;

        function saveState() { 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(State)); 
            App.render(); 
        }

        // --- APP LOGIC ---
        const App = {
            tempDays: [],

            init() {
                setTimeout(() => {
                    document.getElementById('intro-overlay').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('intro-overlay').style.display = 'none';
                        document.getElementById('app-container').classList.add('visible');
                    }, 800);
                }, 2500);
                this.render();
                
                document.querySelectorAll('.day-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.target.classList.toggle('selected');
                        const day = parseInt(e.target.dataset.day);
                        if(this.tempDays.includes(day)) this.tempDays = this.tempDays.filter(d => d !== day);
                        else this.tempDays.push(day);
                    });
                });
            },

            openModal() {
                this.tempDays = [];
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected'));
                document.getElementById('habit-name').value = '';
                document.getElementById('habit-diff').selectedIndex = 1; 
                document.getElementById('add-modal').classList.add('open');
            },

            closeModal(id = 'add-modal') { document.getElementById(id).classList.remove('open'); },

            toggleEveryday() {
                const allSelected = this.tempDays.length === 7;
                this.tempDays = [];
                document.querySelectorAll('.day-btn').forEach(btn => {
                    if (!allSelected) {
                        btn.classList.add('selected');
                        this.tempDays.push(parseInt(btn.dataset.day));
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            },

            saveHabit() {
                const name = document.getElementById('habit-name').value;
                const diffSelect = document.getElementById('habit-diff');
                const diff = diffSelect.options[diffSelect.selectedIndex].value;
                
                if (!name) return alert("Quest name required");
                if (this.tempDays.length === 0) return alert("Select at least one day");

                State.habits.push({
                    id: Date.now(),
                    title: name,
                    diff: diff,
                    days: this.tempDays.sort(),
                    completedDates: [],
                    streak: 0,
                    bestStreak: 0
                });
                this.closeModal();
                saveState();
            },

            toggleHabit(id) {
                const habit = State.habits.find(h => h.id === id);
                const todayStr = new Date().toISOString().split('T')[0];

                if (habit.completedDates.includes(todayStr)) {
                    habit.completedDates = habit.completedDates.filter(d => d !== todayStr);
                    this.recalcStreak(habit);
                    const xp = this.getXP(diffToXP(habit.diff));
                    State.user.xp = Math.max(0, State.user.xp - xp);
                    State.user.totalCompleted = Math.max(0, State.user.totalCompleted - 1);
                } else {
                    habit.completedDates.push(todayStr);
                    this.recalcStreak(habit);
                    const xp = this.getXP(diffToXP(habit.diff));
                    State.user.xp += xp;
                    State.user.totalCompleted++;
                    AudioSys.play('click');
                    this.checkLevelUp();
                    if (!State.activityLog[todayStr]) State.activityLog[todayStr] = 0;
                    State.activityLog[todayStr]++;
                }
                saveState();
            },

            deleteHabit(id) {
                if(confirm("Delete this quest?")) {
                    State.habits = State.habits.filter(h => h.id !== id);
                    saveState();
                }
            },

            recalcStreak(habit) {
                const dates = habit.completedDates.sort().reverse();
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                let streak = 0;
                if (dates.length > 0 && (dates[0] === todayStr || dates[0] === this.getYesterdayStr())) {
                    streak = 1;
                    for(let i=0; i<dates.length-1; i++) {
                        const d1 = new Date(dates[i]);
                        const d2 = new Date(dates[i+1]);
                        const diff = (d1 - d2) / (1000*60*60*24);
                        if (diff === 1) streak++;
                        else break;
                    }
                }
                habit.streak = streak;
                if (streak > habit.bestStreak) habit.bestStreak = streak;
            },

            getYesterdayStr() {
                const d = new Date();
                d.setDate(d.getDate() - 1);
                return d.toISOString().split('T')[0];
            },

            getXP(amount) { return amount; },
            checkLevelUp() {
                if(State.user.xp >= State.user.xpToNext) {
                    State.user.level++;
                    State.user.xp -= State.user.xpToNext;
                    State.user.xpToNext = Math.floor(State.user.xpToNext * 1.2);
                    document.getElementById('level-msg').innerText = `You reached Level ${State.user.level}`;
                    document.getElementById('level-modal').classList.add('open');
                    AudioSys.play('levelup');
                }
            },

            navigate(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const navs = document.querySelectorAll('.nav-btn');
                if(viewId === 'dashboard') navs[0].classList.add('active');
                if(viewId === 'timer') navs[1].classList.add('active');
                if(viewId === 'history') { navs[2].classList.add('active'); Graph.render(); }
                document.getElementById('sidebar').classList.remove('open');
            },

            render() {
                document.getElementById('header-level').innerText = 'LVL ' + State.user.level;
                document.getElementById('xp-text').innerText = `${State.user.xp} / ${State.user.xpToNext} XP`;
                document.getElementById('xp-bar').style.width = `${(State.user.xp / State.user.xpToNext)*100}%`;
                
                const best = State.habits.reduce((max, h) => Math.max(max, h.bestStreak), 0);
                document.getElementById('best-streak').innerText = best;
                document.getElementById('total-quests').innerText = State.user.totalCompleted;

                const todayIndex = new Date().getDay();
                const todayStr = new Date().toISOString().split('T')[0];
                const listContainer = document.getElementById('habit-list-container');
                const sidebarList = document.getElementById('sidebar-habit-list');
                listContainer.innerHTML = '';
                sidebarList.innerHTML = '';
                let currentStreakTotal = 0;

                State.habits.forEach(h => {
                    if (!h.days.includes(todayIndex)) return;
                    const isDone = h.completedDates.includes(todayStr);
                    if (isDone) currentStreakTotal = Math.max(currentStreakTotal, h.streak);

                    const card = document.createElement('div');
                    card.className = `habit-card ${isDone ? 'completed' : ''}`;
                    card.innerHTML = `
                        <div class="habit-left">
                            <div class="check-btn" onclick="App.toggleHabit(${h.id})"></div>
                            <div>
                                <div class="habit-title">${h.title}</div>
                                <div class="habit-meta"><span style="color:var(--primary)">${h.diff.toUpperCase()}</span> <span>üî• ${h.streak}</span></div>
                            </div>
                        </div>
                        <button class="delete-btn" onclick="App.deleteHabit(${h.id})">√ó</button>
                    `;
                    listContainer.appendChild(card);

                    const sbItem = document.createElement('div');
                    sbItem.className = 'sidebar-habit-item';
                    sbItem.innerHTML = `<span>${h.title}</span> <span class="sb-del" onclick="App.deleteHabit(${h.id})">√ó</span>`;
                    sidebarList.appendChild(sbItem);
                });

                if (listContainer.children.length === 0) {
                    listContainer.innerHTML = `<div style="text-align:center; color:#333; padding:2rem;">No missions scheduled for today.</div>`;
                }
                document.getElementById('curr-streak').innerText = currentStreakTotal;
            }
        };

        // --- TIMER MODULE (Pomodoro & Stopwatch) ---
        const Timer = {
            mode: 'pomodoro',
            running: false,
            interval: null,
            raf: null,
            swStartTime: 0,
            pomodoroCycles: 0,
            pomodoroState: 'FOCUS',
            stopwatchTime: 0,
            laps: [],
            circumference: 2 * Math.PI * 120,

            setMode(m) {
                this.pause();
                this.mode = m;
                this.pomodoroCycles = 0;
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                if(m==='pomodoro') document.querySelectorAll('.mode-btn')[0].classList.add('active');
                else document.querySelectorAll('.mode-btn')[1].classList.add('active');
                
                document.getElementById('laps-display').classList.remove('active');
                document.getElementById('btn-lap').style.display = 'none';
                this.reset();
            },

            toggle() {
                if (this.running) this.pause();
                else this.resume();
            },

            resume() {
                this.running = true;
                document.getElementById('btn-start').innerText = "Pause";
                document.getElementById('timer-progress').style.stroke = 'var(--primary)';
                
                if (this.mode === 'pomodoro') {
                    this.interval = setInterval(() => {
                        this.pomodoroTick();
                    }, 1000);
                } else {
                    if (!this.swStartTime) this.swStartTime = Date.now() - this.stopwatchTime;
                    const loop = () => {
                        if(!this.running) return;
                        this.stopwatchTime = Date.now() - this.swStartTime;
                        this.updateDisplay();
                        this.raf = requestAnimationFrame(loop);
                    };
                    this.raf = requestAnimationFrame(loop);
                }
            },

            pause() {
                clearInterval(this.interval);
                cancelAnimationFrame(this.raf);
                this.running = false;
                document.getElementById('btn-start').innerText = "Resume";
                document.getElementById('timer-progress').style.stroke = '#333';
            },

            reset() {
                this.pause();
                if (this.mode === 'pomodoro') {
                    this.pomodoroState = 'FOCUS';
                    this.pomodoroTime = 25 * 60;
                    document.getElementById('timer-status').innerText = 'FOCUS';
                    document.getElementById('btn-start').innerText = "Start";
                } else {
                    // Stopwatch Reset FIX
                    this.stopwatchTime = 0;
                    this.swStartTime = 0; 
                    this.laps = [];
                    document.getElementById('laps-display').innerHTML = '';
                    document.getElementById('timer-status').innerText = 'STOPWATCH';
                    document.getElementById('btn-start').innerText = "Start";
                }
                this.updateDisplay();
            },

            pomodoroTick() {
                if (this.pomodoroTime > 0) {
                    this.pomodoroTime--;
                    this.updateDisplay();
                } else {
                    this.pomodoroComplete();
                }
            },

            pomodoroComplete() {
                this.pause();
                AudioSys.play('click');
                
                if (this.pomodoroState === 'FOCUS') {
                    this.pomodoroCycles++;
                    if (this.pomodoroCycles === 4) {
                        this.pomodoroState = 'LONG';
                        this.pomodoroTime = 20 * 60;
                        alert("Cycle Complete. Take a Long Break (20m).");
                    } else {
                        this.pomodoroState = 'SHORT';
                        this.pomodoroTime = 5 * 60;
                        alert("Focus Done. Short Break (5m).");
                    }
                } else {
                    this.pomodoroState = 'FOCUS';
                    this.pomodoroTime = 25 * 60;
                    alert("Break Over. Back to Work!");
                    
                    if (this.pomodoroCycles === 4) {
                        this.pomodoroCycles = 0; 
                    }
                }
                document.getElementById('timer-status').innerText = this.pomodoroState;
                this.updateDisplay();
            },

            lap() {
                if (this.running && this.mode === 'stopwatch') {
                    this.laps.push(this.stopwatchTime);
                    const container = document.getElementById('laps-display');
                    container.classList.add('active');
                    const div = document.createElement('div');
                    div.className = 'lap-item';
                    const ms = Math.floor((this.stopwatchTime % 1000) / 10);
                    const s = Math.floor((this.stopwatchTime / 1000) % 60).toString().padStart(2,'0');
                    const m = Math.floor((this.stopwatchTime / 60000)).toString().padStart(2,'0');
                    div.innerHTML = `<span class="lap-num">#${this.laps.length}</span> <span>${m}:${s}.${ms.toString().padStart(2,'0')}</span>`;
                    container.prepend(div);
                }
            },

            updateDisplay() {
                let m, s;
                
                if (this.mode === 'pomodoro') {
                    m = Math.floor(this.pomodoroTime/60).toString().padStart(2,'0');
                    s = (this.pomodoroTime%60).toString().padStart(2,'0');
                    document.getElementById('timer-text').innerText = `${m}:${s}`;
                    
                    const max = 25 * 60; 
                    const offset = this.circumference - (this.pomodoroTime / max) * this.circumference;
                    document.getElementById('timer-progress').style.strokeDashoffset = offset;

                } else {
                    const ms = Math.floor((this.stopwatchTime % 1000) / 10);
                    s = Math.floor((this.stopwatchTime / 1000) % 60).toString().padStart(2,'0');
                    m = Math.floor((this.stopwatchTime / 60000)).toString().padStart(2,'0');
                    document.getElementById('timer-text').innerText = `${m}:${s}.${ms.toString().padStart(2,'0')}`;
                    document.getElementById('timer-progress').style.strokeDashoffset = 0; 
                    document.getElementById('btn-lap').style.display = 'inline-block';
                }
            }
        };

        // --- GRAPH & HEATMAP ---
        const Graph = {
            render() {
                this.drawGraph();
                this.drawRing();
                this.drawHeatmap();
            },

            drawGraph() {
                const cvs = document.getElementById('activityCanvas');
                const ctx = cvs.getContext('2d');
                const rect = cvs.parentNode.getBoundingClientRect();
                cvs.width = rect.width;
                cvs.height = rect.height;
                ctx.clearRect(0,0,cvs.width, cvs.height);

                const data = [];
                for(let i=29; i>=0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const str = d.toISOString().split('T')[0];
                    data.push(State.activityLog[str] || 0);
                }

                // Calc Percentage for Graph Title
                const totalTasks = data.reduce((a,b)=>a+b, 0);
                const activeHabits = State.habits.length;
                const goal = activeHabits * 30; // Rough estimate: 5 habits * 30 days = 150
                const pct = goal === 0 ? 0 : Math.round((totalTasks / goal) * 100);
                document.getElementById('graph-pct').innerText = `${pct}% Est. Work`;

                const max = Math.max(...data, 5);
                const stepX = cvs.width / (data.length - 1);
                const padding = 20;
                const h = cvs.height - padding*2;

                ctx.beginPath();
                ctx.strokeStyle = '#00f0ff';
                ctx.lineWidth = 3;
                
                data.forEach((val, i) => {
                    const x = i * stepX;
                    const y = (cvs.height - padding) - ((val / max) * h);
                    if(i===0) ctx.moveTo(x,y);
                    else ctx.lineTo(x,y);
                });
                ctx.stroke();

                ctx.fillStyle = '#111';
                ctx.lineWidth = 2;
                data.forEach((val, i) => {
                    const x = i * stepX;
                    const y = (cvs.height - padding) - ((val / max) * h);
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI*2);
                    ctx.fill();
                    ctx.stroke();
                });
            },

            drawRing() {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const logs = Object.values(State.activityLog).reduce((a,b)=>a+b, 0);
                const daysElapsed = now.getDate();
                const activeHabits = State.habits.length; 
                const potential = activeHabits * daysElapsed; 
                
                const pct = potential === 0 ? 0 : Math.round((logs / potential) * 100);
                
                document.getElementById('consistency-pct').innerText = `${pct}%`;
                const offset = 502 - (pct / 100) * 502;
                document.getElementById('consistency-ring').style.strokeDashoffset = offset;
            },

            drawHeatmap() {
                const grid = document.getElementById('heatmap-grid');
                grid.innerHTML = '';
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                
                for (let d = 1; d <= daysInMonth; d++) {
                    const cell = document.createElement('div');
                    cell.className = 'heat-cell';
                    
                    const dateStr = new Date(year, month, d).toISOString().split('T')[0];
                    const count = State.activityLog[dateStr] || 0;
                    
                    // Determine Intensity based on tasks finished
                    let lvl = 0;
                    if(count > 0) lvl = 1;
                    if(count > 2) lvl = 2;
                    if(count > 4) lvl = 3;
                    if(count > 6) lvl = 4;
                    
                    if(lvl > 0) cell.setAttribute('data-lvl', lvl);
                    cell.title = `${dateStr}: ${count} quests`;

                    const numSpan = document.createElement('span');
                    numSpan.innerText = d;
                    cell.appendChild(numSpan);

                    grid.appendChild(cell);
                }
            }
        };

        function diffToXP(diff) {
            const map = {'easy':10, 'medium':25, 'hard':50};
            return map[diff] || 10;
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        window.onload = () => App.init();
    </script>
</body>
 </html>
